<script>
    // Load saved input on page load
    document.addEventListener('DOMContentLoaded', function() {
        const savedInput = localStorage.getItem('userInput');
        if (savedInput) {
            document.getElementById('textInput').value = savedInput;
        }

        // QR Code Scanner
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const qrResult = document.getElementById('qrResult');

        // Access camera
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                video.srcObject = stream;
                video.play();
                console.log('Camera started');
                scanQRCode();
            })
            .catch(err => {
                console.error('Camera error: ', err);
                qrResult.value = 'Camera access failed: ' + err.message;
            });

        function scanQRCode() {
            console.log('Scanning...');
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // Set canvas size to video size
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                if (canvas.width === 0 || canvas.height === 0) {
                    console.warn('Invalid video dimensions');
                    qrResult.value = 'Invalid video feed';
                    requestAnimationFrame(scanQRCode);
                    return;
                }
                // Draw video frame on canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                // Get image data
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                // Scan for QR code
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                console.log('QR Scan Result:', code);
                if (code) {
                    qrResult.value = code.data; // Display QR code data
                    console.log('QR Code Detected:', code.data);
                    // Optional: Stop camera (comment out for continuous scanning)
                    // video.srcObject.getTracks().forEach(track => track.stop());
                    return; // Stop scanning after detection
                }
            } else {
                console.warn('Video not ready:', video.readyState);
            }
            // Continue scanning
            requestAnimationFrame(scanQRCode);
        }

        // Restart scanning on textbox click (optional)
        qrResult.addEventListener('click', function() {
            if (!video.srcObject) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        video.srcObject = stream;
                        video.play();
                        qrResult.value = 'Scanning QR Code...';
                        scanQRCode();
                    })
                    .catch(err => {
                        console.error('Camera restart error: ', err);
                        qrResult.value = 'Camera restart failed: ' + err.message;
                    });
            }
        });
    });

    document.getElementById('helloButton').addEventListener('click', function() {
        // Show alert
        alert('Hello World');
        // Log click time to Google Sheet
        fetch('https://script.google.com/macros/s/AKfycbxD4mYO6UG6wzVNO4pr8VWRVFAuX_bK2uly7uuX8MJznClrR4nqzr3axn1dqva2S1Rm0Q/exec', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.result === 'success') {
                console.log('Click time logged');
            } else {
                console.log('Error logging click time');
            }
        })
        .catch(error => console.log('Network error: ' + error));
        // Redirect to table.html
        window.location.href = 'table.html';
    });

    document.getElementById('textInput').addEventListener('keydown', function(event) {
        if (event.key === 'Enter' || event.keyCode === 13) {
            const text = this.value.trim();
            if (text) {
                // Show alert with uppercase text
                alert(text.toUpperCase());
                // Send to Google Sheet via Apps Script
                fetch('https://script.google.com/macros/s/AKfycbwLl7O9bcGmntDLr45Yt-wQDD3VC6sWTIAYDZrtv-b3xiKMggmS2SYbNKaIwF-rfFlf/exec', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'text=' + encodeURIComponent(text)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        alert('Data saved to Google Sheet!');
                        localStorage.setItem('userInput', text); // Optional local save
                    } else {
                        alert('Error saving data');
                    }
                })
                .catch(error => alert('Network error: ' + error));
            }
        }
    });
</script>
