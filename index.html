<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Hello World App</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            margin: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        .upper-part {
            display: flex;
            height: 50vh;
            width: 100%;
        }
        .left-top {
            width: 50%;
            height: 100%;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            background-color: #fff;
            display: flex;
            flex-direction: column-reverse; /* Latest at bottom */
        }
        .right-top {
            width: 50%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .bottom-part {
            display: flex;
            flex-direction: column;
            height: 50vh;
            width: 100%;
        }
        .message-bar {
            height: 12.5vh; /* 1/8 of 100vh is 12.5vh */
            width: 100%;
            border: 1px solid #ccc;
            padding: 5px;
            background-color: #fff;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            font-size: 14px;
        }
        .input-box {
            height: 12.5vh;
            width: 100%;
            display: flex;
            align-items: center;
        }
        #textInput {
            width: 60%;
            padding: 5px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #sendButton {
            width: 40%;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
            user-select: none; /* Disable text selection */
        }
        #sendButton:hover {
            background-color: #218838;
        }
        .last-data-box {
            height: 12.5vh;
            width: 100%;
            border: 1px solid #ccc;
            padding: 5px;
            background-color: #fff;
            font-size: 14px;
        }
        .capture-button {
            height: 12.5vh;
            width: 100%;
            font-size: 18px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            user-select: none; /* Disable text selection */
        }
        .capture-button:hover {
            background-color: #0056b3;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #version {
            position: fixed;
            top: 5px;
            left: 5px;
            font-size: 12px;
            font-weight: bold;
            color: #000;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 3px 6px;
            border-radius: 3px;
            z-index: 1000;
        }
        .log-entry {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="version">v1.3.8</div>
    <div class="upper-part">
        <div class="left-top" id="scannedLog"></div>
        <div class="right-top">
            <video id="video" autoplay playsinline></video>
        </div>
    </div>
    <div class="bottom-part">
        <div class="message-bar" id="messageBar"></div>
        <div class="input-box">
            <input id="textInput" type="text" placeholder="Type here or scan...">
            <button id="sendButton">Send</button>
        </div>
        <div class="last-data-box" id="lastDataBox">Last data from sheet: </div>
        <button id="captureButton" class="capture-button">Capture</button>
    </div>
    <canvas id="canvas"></canvas>
    <script src="jsQR.js" onerror="document.getElementById('messageBar').textContent='Error: Failed to load jsQR.js. Check file in C:\\Users\\cws265\\hello_app.'"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js" onerror="document.getElementById('messageBar').textContent='Error: Failed to load jsQR CDN.'"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Google Apps Script URLs
        const CLICK_LOG_URL = 'https://script.google.com/macros/s/AKfycbxD4mYO6UG6wzVNO4pr8VWRVFAuX_bK2uly7uuX8MJznClrR4nqzr3axn1dqva2S1Rm0Q/exec'; // Logs button click timestamps to ClickLogSheet
        const TEXT_INPUT_URL = 'https://script.google.com/macros/s/AKfycbxu8hLb6A8RaoXuxfto6NLUFUM-R9amT2yYzetGGX-miqzZ5SDfV3b3y6RmdUfah-5Z/exec'; // Logs text input to UserInputSheet
        const FETCH_DATA_URL = 'https://script.google.com/macros/s/AKfycbxu8hLb6A8RaoXuxfto6NLUFUM-R9amT2yYzetGGX-miqzZ5SDfV3b3y6RmdUfah-5Z/exec'; // Fetches last 5 inputs from UserInputSheet

        document.addEventListener('DOMContentLoaded', function() {
            // Element references
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const textInput = document.getElementById('textInput');
            const sendButton = document.getElementById('sendButton');
            const captureButton = document.getElementById('captureButton');
            const scannedLog = document.getElementById('scannedLog');
            const messageBar = document.getElementById('messageBar');
            const lastDataBox = document.getElementById('lastDataBox');
            const version = document.getElementById('version');

            // Check for missing elements
            if (!video) { messageBar.textContent += '\nError: Video element not found'; return; }
            if (!canvas) { messageBar.textContent += '\nError: Canvas element not found'; return; }
            if (!textInput) { messageBar.textContent += '\nError: textInput element not found'; return; }
            if (!sendButton) { messageBar.textContent += '\nError: sendButton element not found'; return; }
            if (!captureButton) { messageBar.textContent += '\nError: captureButton element not found'; return; }
            if (!scannedLog) { messageBar.textContent += '\nError: scannedLog element not found'; return; }
            if (!messageBar) { console.log('Error: messageBar element not found'); }
            if (!lastDataBox) { messageBar.textContent += '\nError: lastDataBox element not found'; return; }
            if (!version) { messageBar.textContent += '\nError: version element not found'; } else {
                console.log('Version div loaded: v1.3.8');
            }

            // Load saved input
            const savedInput = localStorage.getItem('userInput');
            if (savedInput) {
                textInput.value = savedInput;
            }

            // Start camera
            let stream = null;
            let track = null;
            startCamera();

            // Verify jsQR is loaded
            if (typeof jsQR === 'undefined') {
                messageBar.textContent += '\nError: jsQR library not loaded. Ensure jsQR.js is in C:\\Users\\cws265\\hello_app or check CDN.';
                return;
            }
            messageBar.textContent += '\njsQR v1.4.0 loaded, ready for scanning.';

            // QR Code Scanner
            const context = canvas.getContext('2d');
            if (!context) {
                messageBar.textContent += '\nError: Failed to get canvas context';
                return;
            }

            function startCamera(facingMode = 'environment') {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode, width: { ideal: 1280 }, height: { ideal: 720 } } })
                    .then(s => {
                        stream = s;
                        track = s.getTracks()[0];
                        video.srcObject = stream;
                        video.play();
                        messageBar.textContent += '\nCamera started (facing: ' + facingMode + ')';
                    })
                    .catch(err => {
                        if (facingMode === 'environment') {
                            messageBar.textContent += '\nRear camera failed: ' + err.message + '. Trying front camera...';
                            startCamera('user');
                        } else {
                            messageBar.textContent += '\nCamera access failed: ' + err.message;
                            qrResult.value = 'Camera error';
                        }
                    });
            }

            function captureQRCode() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: 'attemptBoth'
                    });
                    if (code) {
                        qrResult.value = code.data;
                        messageBar.textContent += '\nQR Code Detected: ' + code.data;
                        addToLog(code.data);
                        textInput.value = code.data; // Replace input box with scanned data
                        stopCamera();
                        return;
                    }
                    messageBar.textContent += '\nNo QR code detected';
                } else {
                    messageBar.textContent += '\nVideo not ready for capture';
                }
            }

            // Stop camera
            function stopCamera() {
                if (track) {
                    track.stop();
                }
            }

            // Resume camera
            function resumeCamera() {
                qrResult.value = '';
                startCamera();
            }

            // Add to scanned log
            function addToLog(data) {
                const logEntry = document.createElement('div');
                logEntry.classList.add('log-entry');
                logEntry.textContent = data;
                scannedLog.appendChild(logEntry); // Append to bottom
                scannedLog.scrollTop = scannedLog.scrollHeight; // Scroll to bottom
            }

            // Tap to focus
            video.addEventListener('click', function(e) {
                if (track && track.applyConstraints) {
                    const rect = video.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width;
                    const y = (e.clientY - rect.top) / rect.height;
                    track.applyConstraints({
                        advanced: [{ focusMode: 'manual', focusDistance: 0.5 }]
                    }).catch(err => console.error('Focus error: ' + err));
                }
            });

            // Clear QR result and resume camera
            clearQrResult.addEventListener('click', function() {
                resumeCamera();
            });

            // Restart scanning on textbox click
            qrResult.addEventListener('click', function() {
                if (!video.srcObject) {
                    resumeCamera();
                }
            });

            // Capture button trigger
            captureButton.addEventListener('click', function() {
                if (video.srcObject) {
                    captureQRCode();
                } else {
                    messageBar.textContent += '\nCamera not ready';
                }
            });

            // Send button handler
            sendButton.addEventListener('click', function() {
                const text = textInput.value.trim();
                if (text) {
                    loadingIcon.style.display = 'inline';
                    successTick.style.display = 'none';
                    fetch(TEXT_INPUT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'text=' + encodeURIComponent(text)
                    })
                    .then(response => response.json())
                    .then(data => {
                        loadingIcon.style.display = 'none';
                        if (data.result === 'success') {
                            successTick.style.display = 'inline';
                            setTimeout(() => { successTick.style.display = 'none'; }, 3000);
                            localStorage.setItem('userInput', text);
                            fetchLastData(); // Update last data box
                        } else {
                            alert('Error saving data');
                        }
                    })
                    .catch(error => {
                        loadingIcon.style.display = 'none';
                        alert('Network error: ' + error);
                    });
                }
            });

            // Clear input button
            clearInput.addEventListener('click', function() {
                textInput.value = '';
                localStorage.removeItem('userInput');
                successTick.style.display = 'none';
                loadingIcon.style.display = 'none';
            });

            // Fetch last data from Google Sheet for lastDataBox
            function fetchLastData() {
                fetch(FETCH_DATA_URL)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const lastEntry = data[data.length - 1];
                            lastDataBox.textContent = 'Last data from sheet: ' + (lastEntry['User Input'] || '');
                        } else {
                            lastDataBox.textContent = 'Last data from sheet: No data available';
                        }
                    })
                    .catch(error => {
                        console.log('Error fetching data: ' + error);
                        lastDataBox.textContent = 'Last data from sheet: Error fetching data';
                    });
            }

            fetchLastData(); // Initial fetch
            setInterval(fetchLastData, 10000); // Refresh every 10 seconds
        });
    </script>
</body>
</html>